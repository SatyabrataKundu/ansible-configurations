---
#
# site.yml - Update Service Profile Template with iSCSI Targets
#
# Author: John McDonough (jomcdono@cisco.com)
#         Cisco Systems, Inc.
#

- hosts: ucs
  connection: local
  gather_facts: no

  tasks:
  - name: Test that we have a UCS host, UCS username, and UCS password
    fail:
      msg: 'Please define the following variables: ucs_hostname, ucs_username and ucs_password.'
    when: ucs_hostname is not defined or ucs_username is not defined or ucs_password is not defined
    vars:
      login_info: &login_info
        hostname: "{{ ucs_hostname }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"

  - name: Update Service Profile Template with iSCSI Targets
    vars:
      service_profile_template_name: VM-Host-Infra-iSCSI-A
      iscsi_vnic_a_name: iSCSI-A-vNIC
      ip_pool_iscsi_pool_a_name: iSCSI-A-vNIC-Pool
      iscsi_lif_01a_ip_address: 10.10.10.01
      iscsi_lif_02a_ip_address: 10.10.10.02
      iscsi_target_name: lun

    ucs_managed_objects:
      <<: *login_info
      objects:
      - module: ucsmsdk.mometa.ls.LsServer
        class: LsServer
        properties:
            parent_mo_or_dn: org-root
            name: "{{ service_profile_template_name }}"
            type: updating-template
        children:
          - module: ucsmsdk.mometa.vnic.VnicIScsiBootParams
            class: VnicIScsiBootParams
            properties:
              policy_owner: local
            children:
              - module: ucsmsdk.mometa.vnic.VnicIScsiBootVnic
                class: VnicIScsiBootVnic
                properties:
                  name: "{{ iscsi_vnic_a_name }}"
                children:
                  - module: ucsmsdk.mometa.vnic.VnicIPv4If
                    class: VnicIPv4If
                    properties: {}
                    children:
                      - module: ucsmsdk.mometa.vnic.VnicIPv4PooledIscsiAddr
                        class: VnicIPv4PooledIscsiAddr
                        properties:
                          ident_pool_name: "{{ ip_pool_iscsi_pool_a_name }}"
                  - module: ucsmsdk.mometa.vnic.VnicIScsiStaticTargetIf
                    class: VnicIScsiStaticTargetIf
                    properties:
                      ip_address: "{{ iscsi_lif_02a_ip_address }}"
                      name: "{{ iscsi_target_name }}"
                      priority: "1"
                    children:
                      - module: ucsmsdk.mometa.vnic.VnicLun
                        class: VnicLun
                        properties:
                          id: "0"
                  - module: ucsmsdk.mometa.vnic.VnicIScsiStaticTargetIf
                    class: VnicIScsiStaticTargetIf
                    properties:
                      ip_address: "{{ iscsi_lif_01a_ip_address }}"
                      name: "{{ iscsi_target_name }}"
                      priority: "2"
                    children:
                      - module: ucsmsdk.mometa.vnic.VnicLun
                        class: VnicLun
                        properties:
                          id: "0"